KDIR ?= @KDIR@
ARCH ?= @ARCH@
KMODDIR=@KMODDIR@
src = @abs_srcdir@
ENABLE_MCOVERLAYFS=@ENABLE_MCOVERLAYFS@

RELEASE=$(shell uname -r | cut -d"." -f1)
ifeq ($(ENABLE_MCOVERLAYFS),yes)
ENABLE_BUILD=$(shell if [ "${RELEASE}" == "4" ]; then echo "yes"; fi)
else
ENABLE_BUILD=no
endif

obj-m += mcoverlay.o

mcoverlay-y := copy_up.o dir.o inode.o readdir.o super.o

.PHONY: clean install modules

modules:
ifeq ($(ENABLE_BUILD),yes)
	$(MAKE) -C $(KDIR) M=$(PWD) SUBDIRS=$(PWD) ARCH=$(ARCH) modules
endif

clean:
	$(RM) .*.cmd *.mod.c *.o *.ko* Module.symvers modules.order -r .tmp*

install:
ifeq ($(ENABLE_BUILD),yes)
	mkdir -p -m 755 $(KMODDIR)
	install -m 644 mcoverlay.ko $(KMODDIR)
endif

